  # ═══════════════════════════════════════════════════════════════════════════
  # Fintech Bank Platform - Docker Compose
  # ═══════════════════════════════════════════════════════════════════════════

  services:
    # ═══════════════════════════════════════════════════════════════════════════
    # KAFKA - KRaft Mode
    # ═══════════════════════════════════════════════════════════════════════════
    kafka:
      image: apache/kafka:3.7.1
      container_name: fintech-kafka
      hostname: kafka
      ports:
        - "9092:9092"
      environment:
        KAFKA_NODE_ID: 1
        KAFKA_PROCESS_ROLES: broker,controller
        KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
        KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

        KAFKA_LISTENERS: INTERNAL://:29092,CONTROLLER://:9093,EXTERNAL://:9092
        KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://localhost:9092
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
        KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
        KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
        KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
        KAFKA_DEFAULT_REPLICATION_FACTOR: 1
        KAFKA_MIN_INSYNC_REPLICAS: 1
        KAFKA_NUM_PARTITIONS: 3
        KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

        KAFKA_LOG_RETENTION_HOURS: 24
        KAFKA_LOG_RETENTION_BYTES: 536870912
      volumes:
        - kafka_data:/var/lib/kafka/data
      networks:
        - fintech-network
      healthcheck:
        test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
        interval: 10s
        timeout: 10s
        retries: 5
        start_period: 60s
      restart: unless-stopped

    # ═══════════════════════════════════════════════════════════════════════════
    # KAFKA UI - Interface Web (profile: ui)
    # ═══════════════════════════════════════════════════════════════════════════
    kafka-ui:
      image: provectuslabs/kafka-ui:v0.7.2
      container_name: fintech-kafka-ui
      ports:
        - "8080:8080"
      environment:
        KAFKA_CLUSTERS_0_NAME: fintech-dev
        KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
        DYNAMIC_CONFIG_ENABLED: "true"
      networks:
        - fintech-network
      depends_on:
        kafka:
          condition: service_healthy
      restart: unless-stopped
      profiles:
        - ui

    # ═══════════════════════════════════════════════════════════════════════════
    # CASSANDRA - Single Node
    # ═══════════════════════════════════════════════════════════════════════════
    cassandra:
      image: cassandra:4.1
      container_name: fintech-cassandra
      hostname: cassandra
      ports:
        - "9042:9042"
      environment:
        CASSANDRA_SEEDS: cassandra
        CASSANDRA_CLUSTER_NAME: fintech-dev
        CASSANDRA_DC: dc1
        CASSANDRA_RACK: rack1
        CASSANDRA_ENDPOINT_SNITCH: SimpleSnitch
        MAX_HEAP_SIZE: 256M
        HEAP_NEWSIZE: 64M
      volumes:
        - cassandra_data:/var/lib/cassandra
      networks:
        - fintech-network
      healthcheck:
        test: ["CMD", "cqlsh", "-e", "describe keyspaces"]
        interval: 30s
        timeout: 10s
        retries: 10
        start_period: 60s
      restart: unless-stopped

    # ═══════════════════════════════════════════════════════════════════════════
    # CASSANDRA WEB - Interface Web (profile: ui)
    # ═══════════════════════════════════════════════════════════════════════════
    cassandra-web:
      image: ipushc/cassandra-web:latest
      container_name: fintech-cassandra-web
      ports:
        - "3000:8083"
      environment:
        CASSANDRA_HOST: cassandra
        CASSANDRA_PORT: 9042
      depends_on:
        cassandra:
          condition: service_healthy
      networks:
        - fintech-network
      restart: unless-stopped
      profiles:
        - ui

    # ═══════════════════════════════════════════════════════════════════════════
    # REDIS - Cache
    # ═══════════════════════════════════════════════════════════════════════════
    redis:
      image: redis:7.2-alpine
      container_name: fintech-redis
      ports:
        - "6379:6379"
      command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
      volumes:
        - redis_data:/data
      networks:
        - fintech-network
      healthcheck:
        test: ["CMD", "redis-cli", "ping"]
        interval: 10s
        timeout: 5s
        retries: 5
      restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════════════════
  # NETWORKS
  # ═══════════════════════════════════════════════════════════════════════════
  networks:
    fintech-network:
      driver: bridge

  # ═══════════════════════════════════════════════════════════════════════════
  # VOLUMES
  # ═══════════════════════════════════════════════════════════════════════════
  volumes:
    kafka_data:
    cassandra_data:
    redis_data:
