# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Fintech Bank Platform - CI Pipeline
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Shared Packages Tests (pkg/)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  pkg:
    name: Shared Packages Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pkg

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: pkg/go.sum

      - name: Download depend√™ncias
        run: go mod download

      - name: Verificar formata√ß√£o
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "‚ùå C√≥digo n√£o formatado. Execute 'gofmt -w .'"
            gofmt -l .
            exit 1
          fi
          echo "‚úÖ C√≥digo formatado corretamente"

      - name: Rodar testes
        run: |
          go test ./... -v -coverprofile=coverage.out
          echo "‚úÖ Testes executados com sucesso"

      - name: Gerar relat√≥rio de cobertura
        run: |
          echo "## üìä Relat√≥rio de Cobertura - Shared Packages (pkg/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extrair porcentagem total
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "### Total: **${COVERAGE}**" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se cobertura √© 100%
          if [ "$COVERAGE" = "100.0%" ]; then
            echo "‚úÖ Cobertura em 100%!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Cobertura abaixo de 100%" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload relat√≥rio de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-pkg
          path: pkg/coverage.out
          retention-days: 30

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # API Gateway Tests
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  api-gateway:
    name: API Gateway Tests
    runs-on: ubuntu-latest
    needs: pkg
    defaults:
      run:
        working-directory: services/api-gateway

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: services/api-gateway/go.sum

      - name: Download depend√™ncias
        run: go mod download

      - name: Verificar formata√ß√£o
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "‚ùå C√≥digo n√£o formatado. Execute 'gofmt -w .'"
            gofmt -l .
            exit 1
          fi
          echo "‚úÖ C√≥digo formatado corretamente"

      - name: Rodar testes
        run: |
          go test ./tests/... -v -coverprofile=coverage.out -coverpkg=./internal/...
          echo "‚úÖ Testes executados com sucesso"

      - name: Gerar relat√≥rio de cobertura
        run: |
          echo "## üìä Relat√≥rio de Cobertura - API Gateway" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extrair porcentagem total
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "### Total: **${COVERAGE}**" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se cobertura √© 100%
          if [ "$COVERAGE" = "100.0%" ]; then
            echo "‚úÖ Cobertura em 100%!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Cobertura abaixo de 100%" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload relat√≥rio de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-api-gateway
          path: services/api-gateway/coverage.out
          retention-days: 30
